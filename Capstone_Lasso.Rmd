---
title: "Capstone: Lasso"
author: "Andrew Knittle"
date: "`r paste('Generated on', Sys.Date())`" 
output: 
  html_document: 
    # try readable or cosmo
    # default (default), try kable, tibble, or paged as an option
    # Options are none (default), show, and hide
    # default is null, try my_style_file.css
    toc: TRUE
    toc_depth: 3
    toc_float: FALSE
    highlight: haddock
    theme: flatly
    df_print: paged
    code_folding: none
    self_contained: TRUE
---

```{r setup, include=FALSE}
# --------------------------------------
# Clean and Prep Environment
rm(list=ls())
set.seed(123)

# --------------------------------------
# Load Libraries
library(pacman)
p_load(ggplot2)
p_load(ISLR)
p_load(dplyr)
p_load(psych)
p_load(ggpubr)
p_load(kableExtra)
p_load(corrplot)
p_load(tidyverse)
p_load(tidyr)
p_load(caret)
p_load(MASS)
p_load(glm.predict)
p_load(glmnet)
p_load(leaps)

# --------------------------------------
# Read Data
setwd(dirname(rstudioapi::getSourceEditorContext()$path))

logDustData = as.data.frame(read.csv('Data/logDustData_Reduced.csv',header=T,sep=','))
logDustData <- logDustData[-1]
logDustData <- logDustData[-1]
logDustData$CASESTAT <- as.factor(logDustData$CASESTAT)
logDustData <- na.omit(logDustData[,c(1:27, 30)])

# --------------------------------------
# Read helper script
source("Exploratory_Support_Scripts.R")
source("Script_Library.R")
source("CrossValidation_Library.R")
source("Model_Building_Library.R")


```

# Method


```{r Model Building, echo=FALSE, fig.cap= "Model Building", out.height="100%", out.width="100%", warning=FALSE, comment=FALSE, warning=FALSE}

# Initialize Lasso Results from method
lassoResult <- NA

# Due to randomness beyond my control, and even having the seed set throughout
# I've saved the result of building a Lasso Model with results that make sense.
# If however the file for it does not exist build it again, but no you may need
# repeat the process several times until you get satisfying results
if(!file.exists("lassoResult.rds")){
  lambda <- 10^seq(10,-2,length=30)
  lassoResult <- buildLasso(logDustData, "CASESTAT", lambda)

}else{
  lassoResult <- readRDS(file = "lassoResult.rds")
}

coef(lassoResult$lasso.mod, s=lassoResult$bestLambda)
# predicted.classes <- ifelse(lassoResult$pred.lasso > 0.5, 0, 1)
# 
# mean(predicted.classes == logDustData$CASESTAT)

# Plot cross validation for lambda
plot(lassoResult$cv.out)

plot(lassoResult$lasso.mod, xvar = "lambda")

# rocFull <- rocBuilder(logDustData$CASESTAT, lassoResult$pred.lasso, toleranceVec = seq(0,1,0.001))
# rocFull[[2]]
# rocDF <- rocFull[[1]]
# simpleAUC(rocDF$`True Positive Rate`, rocDF$`False Positive Rate`)

```

# Perfomnace

```{r Cross Validation, echo=FALSE, fig.cap= "Cross Validation", out.height="100%", out.width="100%", warning=FALSE, comment=FALSE, warning=FALSE}


lassoFit <- lassoResult$lasso.mod
bestLambda <- lassoResult$bestLambda
lasso.formula <- as.formula("CASESTAT ~ D24_1 + DICAMBA_1 + BENZ_A_PYRENE_1 + PCB180_1 + CARBARYL_1 + A_CHLORDANE_1 + CHLORPYRIFOS_1 + DDE_1 + DDT_1 + DIAZINON_1 + METHOXYCHLOR_1 + PROPOXUR_1 + PENTACHLOROPHENOL_1")

lassoCross <- crossValidator.byKPercent(df = logDustData, response = "CASESTAT", 
                                        formula = lasso.formula, family="lasso",bestLambda=bestLambda, tol=0.5)
# Print results of Lasso
errorsDF <- lassoCross[[1]]
crossError(errorsDF)
validCross <- lassoCross[[4]]
rawConfusionBuilder(validCross$Response, validCross$holdout.tolPredict)
```

# Conclusion

# Risk Prediction

```{r Risk Prediction, echo=FALSE, fig.cap= "Risk Prediction", out.height="100%", out.width="100%", warning=FALSE, comment=FALSE, warning=FALSE}

# Plot Deciles
plotDeciles(validCross)

# Plot Deciles by Quantiles
decileQuant <- decilesByQuantiles(validCross$holdout.rawPredict, validCross$Response)
decileQuantDF <- decileQuant[[1]]
decileQuant[[2]]
decileQuant[[3]]
decileQuantDF

```










